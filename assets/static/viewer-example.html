<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GLB 查看器示例 - Field Guide TFG</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        .viewer-container {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            margin: 20px 0;
            background: #f8f9fa;
        }
        
        .control-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .btn-group-vertical .btn {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="bi bi-box"></i>
                    GLB 3D 模型查看器示例
                </h1>
            </div>
        </div>
        
        <div class="row">
            <!-- 3D 查看器区域 -->
            <div class="col-lg-8">
                <div class="viewer-container">
                    <div id="glb-viewer" style="width: 100%; height: 600px;"></div>
                </div>
                
                <!-- 控制按钮 -->
                <div class="mt-3">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-primary" onclick="resetCamera()">
                            <i class="bi bi-camera"></i> 重置视角
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="toggleGrid()">
                            <i class="bi bi-grid-3x3"></i> 切换网格
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="toggleAxes()">
                            <i class="bi bi-arrows-angle-expand"></i> 切换坐标轴
                        </button>
                        <button type="button" class="btn btn-success" onclick="exportImage()">
                            <i class="bi bi-image"></i> 导出图片
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- 控制面板 -->
            <div class="col-lg-4">
                <div class="control-panel">
                    <h5 class="mb-3">
                        <i class="bi bi-gear"></i> 模型控制
                    </h5>
                    
                    <!-- 模型选择 -->
                    <div class="mb-3">
                        <label for="modelSelect" class="form-label">选择模型:</label>
                        <select class="form-select" id="modelSelect" onchange="loadModel(this.value)">
                            <option value="">-- 选择模型 --</option>
                            <option value="output/test_model.glb">测试模型</option>
                            <option value="output/multiblock_3d.glb">多方块模型</option>
                        </select>
                    </div>
                    
                    <!-- 旋转控制 -->
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoRotate" onchange="toggleAutoRotate()">
                            <label class="form-check-label" for="autoRotate">
                                自动旋转
                            </label>
                        </div>
                    </div>
                    
                    <!-- 阴影控制 -->
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="enableShadows" checked onchange="toggleShadows()">
                            <label class="form-check-label" for="enableShadows">
                                启用阴影
                            </label>
                        </div>
                    </div>
                    
                    <!-- 背景颜色 -->
                    <div class="mb-3">
                        <label for="bgColor" class="form-label">背景颜色:</label>
                        <div class="input-group">
                            <input type="color" class="form-control" id="bgColor" value="#f0f0f0" onchange="changeBackground()">
                            <input type="text" class="form-control" id="bgColorText" value="#f0f0f0" onchange="changeBackgroundFromText()">
                        </div>
                    </div>
                    
                    <!-- 动画控制 -->
                    <div class="mb-3" id="animationControls" style="display: none;">
                        <label class="form-label">动画控制:</label>
                        <div class="btn-group-vertical d-grid">
                            <button type="button" class="btn btn-outline-primary" onclick="playAnimation(0)">
                                播放动画
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="stopAnimation()">
                                停止动画
                            </button>
                        </div>
                    </div>
                    
                    <!-- 信息显示 -->
                    <div class="mb-3">
                        <h6>模型信息</h6>
                        <div id="modelInfo" class="text-muted small">
                            <p>尚未加载模型</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Three.js and GLB loader -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/loaders/GLTFLoader.js"></script>
    
    <!-- GLB Viewer -->
    <script src="viewer.js"></script>
    
    <script>
        let viewer = null;
        
        // 初始化查看器
        document.addEventListener('DOMContentLoaded', function() {
            try {
                viewer = new GLBViewer('glb-viewer', {
                    width: 800,
                    height: 600,
                    backgroundColor: 0xf0f0f0,
                    enableControls: true,
                    enableGrid: true,
                    enableAxes: true,
                    enableShadows: true,
                    autoRotate: false
                });
                
                console.log('GLB Viewer initialized successfully');
                
            } catch (error) {
                console.error('Failed to initialize GLB Viewer:', error);
                document.getElementById('glb-viewer').innerHTML = 
                    '<div class="alert alert-danger">无法初始化 3D 查看器: ' + error.message + '</div>';
            }
        });
        
        // 加载模型
        function loadModel(modelPath) {
            if (!modelPath || !viewer) return;
            
            console.log('Loading model:', modelPath);
            
            viewer.loadGLB(modelPath, {
                position: [0, 0, 0],
                scale: [1, 1, 1]
            }).then(gltf => {
                updateModelInfo(gltf);
                
                // 显示动画控制
                if (gltf.animations && gltf.animations.length > 0) {
                    document.getElementById('animationControls').style.display = 'block';
                } else {
                    document.getElementById('animationControls').style.display = 'none';
                }
                
            }).catch(error => {
                console.error('Failed to load model:', error);
                updateModelInfo(null, error.message);
            });
        }
        
        // 更新模型信息
        function updateModelInfo(gltf, error = null) {
            const infoDiv = document.getElementById('modelInfo');
            
            if (error) {
                infoDiv.innerHTML = `<p class="text-danger"><i class="bi bi-exclamation-triangle"></i> 加载失败: ${error}</p>`;
                return;
            }
            
            if (!gltf) {
                infoDiv.innerHTML = '<p>尚未加载模型</p>';
                return;
            }
            
            let html = '<div>';
            
            // 模型信息
            if (gltf.scene) {
                html += `<p><strong>场景:</strong> 已加载</p>`;
            }
            
            // 动画信息
            if (gltf.animations && gltf.animations.length > 0) {
                html += `<p><strong>动画数量:</strong> ${gltf.animations.length}</p>`;
                gltf.animations.forEach((anim, index) => {
                    html += `<p><small>动画 ${index + 1}: ${anim.name || '未命名'} (${anim.duration.toFixed(2)}s)</small></p>`;
                });
            } else {
                html += `<p><strong>动画:</strong> 无</p>`;
            }
            
            html += '</div>';
            infoDiv.innerHTML = html;
        }
        
        // 重置相机
        function resetCamera() {
            if (viewer) {
                viewer.fitCameraToModel();
            }
        }
        
        // 切换网格
        function toggleGrid() {
            if (viewer && viewer.gridHelper) {
                viewer.gridHelper.visible = !viewer.gridHelper.visible;
            }
        }
        
        // 切换坐标轴
        function toggleAxes() {
            if (viewer && viewer.axesHelper) {
                viewer.axesHelper.visible = !viewer.axesHelper.visible;
            }
        }
        
        // 切换自动旋转
        function toggleAutoRotate() {
            const checked = document.getElementById('autoRotate').checked;
            if (viewer && viewer.controls) {
                viewer.controls.autoRotate = checked;
            }
        }
        
        // 切换阴影
        function toggleShadows() {
            const checked = document.getElementById('enableShadows').checked;
            // 这里需要重新初始化查看器，因为阴影设置需要在创建时配置
            console.log('Toggle shadows:', checked);
        }
        
        // 改变背景颜色
        function changeBackground() {
            const color = document.getElementById('bgColor').value;
            document.getElementById('bgColorText').value = color;
            
            if (viewer && viewer.scene) {
                viewer.scene.background = new THREE.Color(color);
            }
        }
        
        function changeBackgroundFromText() {
            const color = document.getElementById('bgColorText').value;
            document.getElementById('bgColor').value = color;
            changeBackground();
        }
        
        // 播放动画
        function playAnimation(index) {
            if (viewer) {
                viewer.playAnimation(index);
            }
        }
        
        // 停止动画
        function stopAnimation() {
            if (viewer) {
                viewer.stopAnimation();
            }
        }
        
        // 导出图片
        function exportImage() {
            if (viewer) {
                const dataURL = viewer.exportImage();
                const link = document.createElement('a');
                link.download = 'glb-model-screenshot.png';
                link.href = dataURL;
                link.click();
            }
        }
    </script>
</body>
</html>